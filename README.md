# 黒鯱（KuroShachi）v1.0.1 基本設計書

## 0. コンセプト

### 0.1 ツール名

#### 名称
**黒鯱（くろしゃち / Kuroshachi）**

#### 表記ルール
- 日本語表記：黒鯱
- 英語表記：Kuroshachi
- 補助表記（用途に応じて）
  - 黒鯱 PDF
  - 黒鯱 PDF Search

---

### 0.2 ネーミングコンセプト
Cross SearchをもじってKuroShachi

#### 名前の由来

**黒鯱（シャチ）**は、海の生態系における頂点捕食者であり、以下の特性を持つ存在です。

- 圧倒的な探索能力
- 高い知性と判断力
- 群れを率いる統率力
- 一度見つけた獲物を逃さない追跡力
- 無駄のない合理的な動き

黒鯱は、
**大量のPDFファイルを横断的に探索し、必要な情報を確実に見つけ出す**
という本ツールの本質を象徴する名称です。

#### 「黒」に込めた意味

- 黒：業務を邪魔しない存在
- 黒：主張しすぎないプロフェッショナルツール
- 黒：情報を扱う「裏方」としての信頼感

UIやロゴにおいても、
**派手さより集中・安定・信頼性**を重視しています。

---

### 0.3 プロダクトコンセプト

#### コンセプトキーワード
- 横断探索
- 見逃さない
- 深く潜る
- 素早く見つける
- 業務に耐える

#### コンセプトステートメント

> 黒鯱は、  
> 情報の海に深く潜り、  
> 必要な情報だけを確実に捕まえる  
> PDF横断検索ツールです。

---

### 0.4 ロゴ・マークコンセプト

#### ロゴマーク（シンボル）

##### モチーフ
- シャチ（鯱）
- 波
- 円形フレーム

##### 意味
- **シャチ**：探索力・捕捉力・知性
- **波**：大量のPDF、情報の海
- **円**：横断検索、循環、完結性

ロゴマークは以下を前提に設計されています。

- アプリアイコンとして成立する
- マーク単体でも識別可能
- 小サイズ（タスクバー等）でも判別可能

#### カラー設計

##### メインカラー
- ブラック `#000000`
  - シャチ本体
  - 文字ロゴ

##### サブカラー
- 黒鯱ブルー `#6a87d6`
  - 波モチーフ
  - 円形フレーム
  - UIアクセント

##### カラー方針
- グラデーション・装飾は最小限
- フラットデザイン
- 視認性・再現性を最優先

#### 文字ロゴ（黒鯱）

##### デザイン方針
- 角ばり強め
- 直線基調
- 工業的・無機質
- 和風すぎないモダンさ

##### 重視ポイント
- 「鯱」の中の **「虎」** を省略しない
- 意味が判別できる字形を維持
- ロゴでありながら「読める」ことを最優先

---

### 0.5 「PDF」という言葉を前面に出さない理由

- 将来的な拡張（他形式対応）を妨げないため
- 本質は「PDF」ではなく「情報探索」にあるため
- 名前としての記憶性・強度を優先したため

必要に応じて、
**黒鯱 PDF / 黒鯱 PDF Search**
といった補助表記を使用します。

---

### 0.6 想定ユースケース

- 業務マニュアルの横断検索
- 技術資料・設計書の高速参照
- 監査・レビュー時の証跡探索
- 社内ナレッジの再発見

---

### 0.7 ブランドトーン

| 要素 | 方針 |
|---|---|
| 派手さ | 抑える |
| 信頼感 | 最優先 |
| 可愛さ | 不要 |
| 説明臭さ | 排除 |
| 業務適合性 | 重視 |

---

### 0.8 コンセプトまとめ

> 黒鯱は、  
> 情報の海に潜り、  
> 必要な答えだけを確実に捕まえる  
> プロフェッショナル向け探索ツールです。

---

## 1. システム概要
黒鯱（KuroShachi）は、ローカル環境にある複数のPDFファイルをデータベース化し、高速な全文検索とプレビュー閲覧を行うためのデスクトップアプリケーションです。ユーザーはキーワードを用いて登録済みPDFの横断検索を行い、検索語がハイライトされた状態で内容を閲覧・コピーすることができます。

## 2. システム構成

### 2.1 開発環境・依存ライブラリ
* **言語:** Python 3.x
* **GUIフレームワーク:** 
    * Tkinter / ttk（基本フレームワーク）
    * ttkbootstrap（モダンなテーマ適用、オプション）
* **PDF処理:**
    * PyMuPDF (`fitz`)
    * pypdf
* **画像処理:** Pillow (`PIL`)
* **データベース:** SQLite3 (FTS5拡張利用)
* **形態素解析:** MeCab (ipadic) - 日本語テキストの前処理に使用
* **その他:**
    * tkinterweb（HTML表示用、オプション）
    * markdown（ガイドのブラウザ表示用）

### 2.2 ファイル構成
* `kuroshachi.pyw`: アプリケーション本体スクリプト
* `pdf_index.db`: インデックスデータ保存用SQLiteデータベース
* `pdf_cross_search.log`: ログ出力先
* `requirements_kuroshachi.txt`: 依存関係定義ファイル
* `kuroshachi.spec`: PyInstaller設定ファイル
* `build_kuroshachi.bat`: EXEビルド用バッチファイル
* `guide.md`: 使い方ガイド（Markdown形式）
* `kuroshachi_icon.ico`: アプリケーションアイコン（.ico形式）
* `kuroshachi_icon_512.png`: アプリケーションアイコン（.png形式）

---

## 3. 機能一覧

| 機能カテゴリ | 機能名 | 説明 |
| :--- | :--- | :--- |
| **ファイル管理** | PDF追加 | ファイルダイアログからPDFを選択し、DBへ登録・インデックス化を行う |
| | 登録クリア | 追加済みPDFにあるすべての登録を解除する |
| | PDF削除 | 登録済みPDFをリストおよびDBから削除する（右クリックメニュー） |
| | フォルダを開く | PDFファイルが保存されているフォルダを開く（右クリックメニュー） |
| | 一覧表示 | 登録済みのPDFファイル名を表示する |
| **検索機能** | 全文検索 | キーワードによる横断検索（AND検索、フレーズ検索対応） |
| | 検索オプション | 大文字小文字を区別（スイッチでON/OFF） |
| | 結果表示 | 該当するファイル名とページ番号を表示する |
| | 検索結果保存 | 検索語とフレーズ検索の状態を保存する |
| | 保存リスト | 保存した検索語の一覧を表示し、クリックで再検索を実行する |
| **閲覧機能** | PDF表示 | 選択したPDFページを描画し表示する |
| | ハイライト | 検索キーワードをページ上で色分けしてハイライト表示する |
| | 拡大・縮小 | マウスホイールによるズーム操作 |
| | 検索結果ナビゲーション | Ctrl+ホイールで検索結果の前後を移動 |
| | テキスト選択 | 右クリックドラッグによるテキスト選択とクリップボードへのコピー |
| | 手のひらツール | 左クリックドラッグによるページの移動（パン） |
| | プレビュー | 画面右上に1ページ目のサムネイルを表示する |
| | メタデータ表示 | PDFのファイル名、サイズ、ページ数、作成日、更新日等の情報を表示する |
| | ナビゲーションボタン | 検索結果の前後移動と初期表示へのリセット |
| **UI機能** | 左パネル折りたたみ | 左側の検索パネルを折りたたみ/展開できる（☰/✕ボタン） |
| | PDFダブルクリック | 追加済みPDFをダブルクリックでプレビュー表示 |
| **ヘルプ機能** | 操作説明 | マウス操作の説明を表示するダイアログ |
| | 使い方ガイド | 詳細な使い方ガイドをウィンドウ内で表示（Markdown形式） |
| | ブラウザで見る | 使い方ガイドをブラウザで表示（リッチなデザイン） |
| | バージョン情報 | アプリケーションのバージョン情報を表示 |

---

## 4. データベース設計 (SQLite)

### 4.1 テーブル定義

**1. pdf_files (ファイル管理テーブル)**
* 登録されたPDFファイルの物理情報を管理。
    * `id`: INTEGER PRIMARY KEY AUTOINCREMENT
    * `filepath`: TEXT UNIQUE (ファイルパス)
    * `filename`: TEXT (ファイル名)
    * `file_hash`: TEXT (重複チェック用ハッシュ)
    * `last_modified`: DATETIME (最終更新日時)

**2. pdf_contents_fts (全文検索用仮想テーブル)**
* SQLiteのFTS5拡張を利用した高速検索用テーブル。
    * `content`: TEXT (抽出・整形されたテキスト)
    * `pdf_id`: UNINDEXED (ファイルID)
    * `page`: UNINDEXED (ページ番号)

**4. saved_search_results (保存検索結果テーブル)**
* 保存された検索クエリを管理。
    * `id`: INTEGER PRIMARY KEY AUTOINCREMENT
    * `query`: TEXT (検索語)
    * `is_phrase_search`: INTEGER (フレーズ検索ON/OFF: 0/1)
    * `timestamp`: DATETIME (保存日時)

**3. pdf_metadata (メタデータテーブル)**
* PDFの付帯情報を管理。
    * `id`: INTEGER PRIMARY KEY AUTOINCREMENT
    * `pdf_id`: INTEGER (外部キー)
    * `title`: TEXT
    * `author`: TEXT
    * `creation_date`: TEXT
    * `modification_date`: TEXT
    * `producer`: TEXT
    * `page_count`: INTEGER

---

## 5. UI/画面設計

メイン画面は `1440x900` のサイズで初期化され、左右の `PanedWindow`（分割ウィンドウ）で構成される。左パネルは `weight=1`（約14%）、右パネルは `weight=6`（約86%）の比率で分割される。

### 5.1 左ペイン（操作パネル：約14%）
1.  **PDF追加・登録クリア**
    * 「PDFを追加」ボタン
    * 「登録クリア」ボタン
2.  **PDFファイルリスト**
    * 「追加済みPDF」ラベルフレーム（高さ固定：200px）
    * ファイル名一覧を表示するTreeview
    * ダブルクリックでプレビュー表示
    * 右クリックメニュー（「フォルダを開く」「削除」コマンド）
3.  **検索エリア**
    * 検索ワード入力欄（フォント: `Yu Gothic UI` 12pt）
    * 「検索」ボタン
4.  **フレーズ検索・検索オプション**
    * 「フレーズ検索」チェックボックス
    * 「大文字小文字を区別」チェックボックス（フレーズ検索の右側に配置）
5.  **検索結果管理**
    * 「検索結果クリア」ボタン
    * 「検索結果保存」ボタン
    * 「保存リスト」ボタン
6.  **検索結果エリア**
    * 「検索結果」ラベルフレーム
    * 結果表示Treeview（カラム：ファイル名、ページ）
    * 検索結果をクリックすると該当ページを表示
7.  **左パネル折りたたみ**
    * 「☰」（ハンバーガーメニュー）/「✕」（閉じる）ボタンで左パネルを折りたたみ/展開
    * 折りたたみ時はsash位置を保存し、展開時に復元

### 5.2 右ペイン（ビューアパネル：約86%）
1.  **プレビューフレーム（右上固定）**
    * **ヘルプボタン（上部）**
        * 「操作説明」ボタン：マウス操作の説明を表示
        * 「使い方ガイド」ボタン：詳細な使い方ガイドをウィンドウ内で表示
        * 「バージョン情報」ボタン：アプリケーションのバージョン情報を表示
    * **サムネイル表示**
        * サムネイル画像（A4比率：200x283）
        * PDFが読み込まれていない場合は表示しない
    * **PDFメタ情報表示**
        * 表示順序：ファイル名、ファイルサイズ、ページ数、作成日、更新日、PDFバージョン、セキュリティ、作成者、タイトル、アプリケーション
        * フォントサイズ：9pt（ラベルと値）
    * **ナビゲーションボタン（一番下に配置）**
        * 「◀」ボタン：検索結果の前の項目に移動
        * 「📄」ボタン：初期表示に戻る（拡大縮小をリセット）
        * 「▶」ボタン：検索結果の次の項目に移動
        * 中央揃えで配置、上部マージンは大きめに設定
2.  **メインビューア（中央・左側）**
    * PDFページ描画用キャンバス
    * **初回起動時・PDF未読み込み時**
        * ロゴ画像（256x256px）を中央に表示
        * 「黒鯱」と「（KuroShachi）」を表示
        * 「Version 1.0.1」を表示
        * テキストは白、行間を空けて表示
    * 垂直スクロールバー
    * **マウス操作**
        * マウスホイール：拡大・縮小
        * Ctrl + ホイール：検索結果の前後を移動（上にスクロールで前へ、下にスクロールで次へ）
        * 左クリックドラッグ：手のひらツール（パン）でページを移動
        * 右クリックドラッグ：テキスト選択（黄色でハイライト表示）

---

## 6. 詳細処理ロジック

### 6.1 インデックス登録処理
1.  PDFファイルを `fitz` (PyMuPDF) で開く。
2.  ファイル情報（パス、ハッシュ、更新日時）を `pdf_files` テーブルに登録または更新。
3.  メタデータを `pdf_metadata` テーブルに登録。
4.  全ページのテキストを抽出し、`preprocess_text` メソッドで前処理を実施。
    * **MeCabによる結合処理:** 行末と次行頭で名詞が分断されている場合、これらを結合してインデックス精度を向上させる（例：「開発」が「開\n発」となっている場合など）。
5.  前処理後のテキストを `pdf_contents_fts` に登録。

### 6.2 検索クエリ解析処理
ユーザーの入力文字列を以下のルールで解析し、SQLクエリを構築する。
* **フレーズ検索:** ダブルクォート `"` で囲まれた文字列、または「フレーズ検索」チェックボックスがONの場合。完全一致のフレーズを検索する。
* **AND検索:** スペース区切りの複数単語（すべての単語を含むページを検索）。デフォルトの検索モード。
* **検索オプション:**
    * **大文字小文字を区別:** チェックボックスでON/OFF可能。`PRAGMA case_sensitive_like = ON/OFF` で制御。フレーズ検索の右側に配置されている。

### 6.3 ハイライト処理
検索語が見つかった場合、以下の色順序でページ上にハイライトを描画する。
1.  デフォルト（黄色）
2.  薄い緑 `(0.5, 1, 0.5)`
3.  薄い青 `(0.5, 0.8, 1)`
4.  薄い紫 `(1, 0.5, 1)`

---

## 7. EXE化について

本アプリケーションはPyInstallerを使用して単一のEXEファイルにビルドできます。

### 7.1 ビルド方法
簡単な手順は以下の通りです：

1. `build_kuroshachi.bat` を実行
2. `dist\kuroshachi.exe` が生成されます

### 7.2 EXE化の利点
* Python環境が不要で、どこでも実行可能
* 依存関係がすべてバンドルされる
* 配布が簡単

### 7.3 データベースの扱い
* `pdf_index.db` は EXE と同じディレクトリに作成されます（相対パス）
* EXE を上書きするだけなら、既存の `pdf_index.db` は保持されます
* 既存ユーザーは EXE を上書きするだけで、既存のインデックスデータをそのまま使用できます

---

## 8. 特記事項 / 制限事項

### 8.1 技術的な制限事項
* **MeCabの辞書パス:** 動的に検出されるようになりました。EXE化時は自動的にバンドルされます。
    * 通常実行時: `site-packages` から自動検出
    * EXE実行時: バンドルされた辞書を使用
    * フォールバック: 特定のユーザーパスも試行
* **IME制御:** 入力ウィジェットに対してIMEをアクティブにする制御が含まれている（Windows環境依存）。
* **ハイライト表示の制限:** 検索語が改行されていたり、ハイフネーション（例：`develop-\nment`）で改行されている場合、検索自体は正常に動作しますが、ページ上にマーカー（ハイライト）を付与できない場合があります。これは、PDF内のテキストが物理的に分割されているため、ハイライト表示の座標計算が困難になるためです。このような場合でも、検索結果には正しく表示されるため、該当ページを確認して手動で内容を確認してください。

### 8.2 UI/UXに関する注意事項
* **ttkbootstrap:** オプションライブラリです。インストールされていない場合は標準のttkスタイルで動作します。
* **左パネルの幅:** 折りたたみ/展開時にsash位置を保存・復元するため、ユーザーが調整した幅が保持されます。
* **使い方ガイド:** ウィンドウ内で表示するほか、「ブラウザで見る」ボタンでリッチなデザインのHTML版を表示できます。

### 8.3 リリース時の注意事項
* **EXE配布:** `build_kuroshachi.bat` を実行して `dist\kuroshachi.exe` を生成
* **データベース:** 既存の `pdf_index.db` は保持されるため、EXEの上書きのみでアップデート可能
* **ガイドファイル:** `guide.md` は EXE に同梱されるため、単体のEXEファイルのみで配布可能

---

## 9. 更新履歴

### v1.0.1 (2026-01-XX)
- **UI改善**
  - 追加済みPDFリストに縦横スクロールバーを追加
  - プレビューエリアのナビゲーションボタンの位置を調整（上に移動）

### v1.0.0 (2026-01-XX)
- 初回リリース
  - PDFファイルの横断検索機能
  - 全文検索（AND検索、フレーズ検索対応）
  - 検索結果のハイライト表示
  - PDFプレビュー機能
  - 検索結果の保存・読み込み機能
  - 左パネルの折りたたみ機能
  - 使い方ガイド機能